<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> (ATTicket:560142) Re: Comments on at91_can.c
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/socketcan-core/2009-September/index.html" >
   <LINK REL="made" HREF="mailto:socketcan-core%40lists.berlios.de?Subject=Re%3A%20%28ATTicket%3A560142%29%20Re%3A%20Comments%20on%20at91_can.c&In-Reply-To=%3C4A9E2B35.8050903%40pengutronix.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002959.html">
   <LINK REL="Next"  HREF="002961.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>(ATTicket:560142) Re: Comments on at91_can.c</H1>
    <B>Marc Kleine-Budde</B> 
    <A HREF="mailto:socketcan-core%40lists.berlios.de?Subject=Re%3A%20%28ATTicket%3A560142%29%20Re%3A%20Comments%20on%20at91_can.c&In-Reply-To=%3C4A9E2B35.8050903%40pengutronix.de%3E"
       TITLE="(ATTicket:560142) Re: Comments on at91_can.c">mkl at pengutronix.de
       </A><BR>
    <I>Wed Sep  2 10:22:13 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="002959.html">Comments on at91_can.c
</A></li>
        <LI>Next message: <A HREF="002961.html">MSCAN driver
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2960">[ date ]</a>
              <a href="thread.html#2960">[ thread ]</a>
              <a href="subject.html#2960">[ subject ]</a>
              <a href="author.html#2960">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Hey Frederic,

thanks for your support,

<A HREF="https://lists.berlios.de/mailman/listinfo/socketcan-core">at91 at atmel.com</A> wrote:
&gt;<i> In fact these error bits are NOT latched. That constraint which is
</I>&gt;<i> not a bug is described in the CAN controller section of the
</I>&gt;<i> datasheet: section 36.6.4.6 Error Interrupt Handler
</I>
I can live with the fact that these bits are not latched.

&gt;<i> WARN, BOFF, ERRA and ERRP (CAN_SR) represent the current status of the CAN bus and
</I>&gt;<i> are not latched. They reflect the current TEC and REC (CAN_ECR) values as described in Section
</I>&gt;<i> 36.6.4.5 &#8220;Fault Confinement&#8221; on page 516.
</I>
&gt;<i> Based on that, if these bits are used as an interrupt, the user can enter into an interrupt and not
</I>&gt;<i> see the corresponding status register if the TEC and REC counter have changed their state.
</I>&gt;<i> When entering Bus Off Mode, the only way to exit from this state is 128 occurrences of 11 consecutive
</I>&gt;<i> recessive bits or a CAN controller reset.
</I>
The Datasheet says Bus Off can only be left with a reset or that 128x11
recessive bits.

I have a setup that forces the at91 to go into bus off, this basically
works.

&gt;<i> &lt;7&gt;at91_can at91_can: at91_irq_err: ECR=0x00000004, TEC=  0 (bus-off!),
</I>&gt;<i> REC=  4, bits set: ERRP BOFF
</I>
The bus off raises an interrupt. As you see here, the Error Passive and
the Bus Off bits are set. However the Transmit Error Counter shows &quot;0&quot;
maybe internally it shows 256, but the ECR register only contains 8 bit
(= maximum of 255) of it.

Taking the Datasheet by word, the Bus Off bit shouldn't be set, because
it is not latched and TEC and REC are quite small. Sounds like a bug,
though. This is not nice, but I can live with that.

(The status register and the ECR register are read quite closely in the
same interrupt handler, in case you assume a race condition in my code.)

Then after the bus off interrupt handler returns, the chip still tries
to send packages although the chip is in bus off, this does not conform
the CAN spec (and the datasheet), my setup still forces the transmit
errors to increase and suddenly the TEC shows &quot;16&quot;.

&gt;<i> &lt;7&gt;at91_can at91_can: at91_irq_err: ECR=0x00100000, TEC= 16, REC=  0,
</I>&gt;<i> bits set: ERRA
</I>
I didn't to anything to reset the chip.

The Datasheet talks about the 128x11 recessive bits as a possibility to
leave the bus off. Can the 128x11 be generated by my setup? How can I be
sure my setup doesn't generate that condition? Or asked the other way
how do I generate the 128x11?

I have a different setup to bring the chip into a bus off. It looks like
this: I just have the at91 sending packages, no other stations on the
CAN bus. To generate errors I plug and unplug the terminator. So I have
an unterminated and a single terminated bus alternating. This too send
the chip into bus off. When keep injecting errors the bus off goes
&quot;away&quot; as described above. However I'm not sure if the RX or TX errors
increases. But I can redo the test.

Upon reconnecting the at91-in-bus-off to a proper CAN network the packet
in the Chip is delivered to the other stations. According to the CAN
spec a Chip in Bus Off should not do anything with the bus.

cheers, Marc

- --
Pengutronix e.K.                         | Marc Kleine-Budde           |
Linux Solutions for Science and Industry | Phone: +49-231-2826-924     |
Vertretung West/Dortmund                 | Fax:   +49-5121-206917-5555 |
Amtsgericht Hildesheim, HRA 2686         | <A HREF="http://www.pengutronix.de">http://www.pengutronix.de</A>   |
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 (GNU/Linux)
Comment: Using GnuPG with Mozilla - <A HREF="http://enigmail.mozdev.org">http://enigmail.mozdev.org</A>

iEYEARECAAYFAkqeKzUACgkQjTAFq1RaXHO9nwCdFuKMo22DKEth+Np4Wz91vsll
QioAn39/g8Nncx0zCiGVpFJuLra/B1MT
=ZTWV
-----END PGP SIGNATURE-----

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002959.html">Comments on at91_can.c
</A></li>
	<LI>Next message: <A HREF="002961.html">MSCAN driver
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2960">[ date ]</a>
              <a href="thread.html#2960">[ thread ]</a>
              <a href="subject.html#2960">[ subject ]</a>
              <a href="author.html#2960">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/socketcan-core">More information about the Socketcan-core
mailing list</a><br>
</body></html>
