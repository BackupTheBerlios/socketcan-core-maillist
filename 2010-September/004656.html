<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> Self-reception and more
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/socketcan-core/2010-September/index.html" >
   <LINK REL="made" HREF="mailto:socketcan-core%40lists.berlios.de?Subject=Re%3A%20Self-reception%20and%20more&In-Reply-To=%3C4C98F490.4030004%40grandegger.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004654.html">
   <LINK REL="Next"  HREF="004657.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>Self-reception and more</H1>
    <B>Wolfgang Grandegger</B> 
    <A HREF="mailto:socketcan-core%40lists.berlios.de?Subject=Re%3A%20Self-reception%20and%20more&In-Reply-To=%3C4C98F490.4030004%40grandegger.com%3E"
       TITLE="Self-reception and more">wg at grandegger.com
       </A><BR>
    <I>Tue Sep 21 20:08:16 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="004654.html">Self-reception and more
</A></li>
        <LI>Next message: <A HREF="004657.html">Self-reception and more
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4656">[ date ]</a>
              <a href="thread.html#4656">[ thread ]</a>
              <a href="subject.html#4656">[ subject ]</a>
              <a href="author.html#4656">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/21/2010 06:49 PM, <A HREF="https://lists.berlios.de/mailman/listinfo/socketcan-core">gribov at ixxat.de</A> wrote:
&gt;<i> Hello Oliver,
</I>&gt;<i> Hello Wolfgang,
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;&gt;&gt;<i> If the self reception message is looped back to Rx queue in Tx 
</I>&gt;&gt;&gt;<i> interrupt (3) end becomes time stamp exactly at this moment - when we
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> are getting the correct starting point for our timeout countdown. And
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> important issue - if we are using active CAN interface (the one with 
</I>&gt;&gt;&gt;<i> own microcontroller), the timestamp shall be generated by 
</I>&gt;&gt;&gt;<i> microcontroller and passed to SocketCAN driver.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The timestamp is set in netif_rx(). In the case above it's done at tx
</I>&gt;&gt;<i> completion interrupt, which looks like the behaviour you prefer to
</I>&gt;<i> have.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Especially i would take a look into the per-socket filters, that would
</I>&gt;<i> allow
</I>&gt;&gt;<i> you to filter for exact CAN-Identifiers, which prevents your socket
</I>&gt;<i> rx-queue
</I>&gt;&gt;<i> to contain other stuff, that's sorted out in userspace. The used
</I>&gt;<i> rx-queue
</I>&gt;&gt;<i> could be really short then.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> E.g. you could use different sockets for different CAN-ID filters (and
</I>&gt;<i> the
</I>&gt;&gt;<i> select()-syscall) to handle all of them in your userspace app.
</I>&gt;<i> 
</I>&gt;<i> I was checking the sja100_start_xmit from sja1000.c and was captured by
</I>&gt;<i> the 
</I>&gt;<i> line:
</I>&gt;<i> 
</I>&gt;<i> .
</I>&gt;<i> 	can_put_echo_skb(skb, dev, 0);
</I>&gt;<i> .
</I>&gt;<i> 
</I>&gt;<i> I thought this is the moment, when the tx message is looped back. But
</I>&gt;<i> obviously
</I>&gt;<i> this is happening in sja1000_interrupt on Tx interrupt event by the mean
</I>&gt;<i> of:
</I>&gt;<i> 
</I>&gt;<i> .
</I>&gt;<i> 	can_get_echo_skb(dev, 0);
</I>&gt;<i> 	netif_wake_queue(dev);
</I>&gt;<i> .
</I>&gt;<i> 
</I>&gt;<i> If this is like that, than I am surely OK with it.
</I>
The code is your friend:

<A HREF="http://lxr.linux.no/#linux+v2.6.35.5/drivers/net/can/dev.c#L311">http://lxr.linux.no/#linux+v2.6.35.5/drivers/net/can/dev.c#L311</A> should
convinse you.

&gt;<i> I like the idea for using several opened socket on one interface for
</I>&gt;<i> it's
</I>&gt;<i> elegance, but afraid this is not applicable due to very critical
</I>&gt;<i> requirement:
</I>&gt;<i> the order of messages for both Tx and Rx messages shall be kept. 
</I>&gt;<i> 
</I>&gt;<i> Example from CANopen for reception: 
</I>&gt;<i> Imagine two CAN messages on the bus coming very close.
</I>&gt;<i> The first is PDO with data and the second is NMT command &quot;switch to
</I>&gt;<i> preop&quot;.
</I>&gt;<i> Received by the CANopen application in that order, this sequence will
</I>&gt;<i> cause
</I>&gt;<i> data update (PDO) and NMT state transition in state &quot;preop&quot; (we assume
</I>&gt;<i> state
</I>&gt;<i> &quot;operational&quot; before). In the &quot;preop&quot; state PDO processing is disabled.
</I>&gt;<i> So if
</I>&gt;<i> due to reception of PDO and NMT over different sockets the order of
</I>&gt;<i> message
</I>&gt;<i> processing will be changed (NMT before PDO), the application will switch
</I>&gt;<i> to
</I>&gt;<i> &quot;preop&quot; before processing the PDO and the data from that PDO will be
</I>&gt;<i> lost.
</I>
Well, I do actually not understand why it's elagant to use more than one
socket/thread for a serialized task.

Wolfgang.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004654.html">Self-reception and more
</A></li>
	<LI>Next message: <A HREF="004657.html">Self-reception and more
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4656">[ date ]</a>
              <a href="thread.html#4656">[ thread ]</a>
              <a href="subject.html#4656">[ subject ]</a>
              <a href="author.html#4656">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/socketcan-core">More information about the Socketcan-core
mailing list</a><br>
</body></html>
