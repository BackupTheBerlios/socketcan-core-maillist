<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [PATCH net-next-2.6 v5 1/1] can: c_can: Added support for Bosch	C_CAN controller
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/socketcan-core/2011-February/index.html" >
   <LINK REL="made" HREF="mailto:socketcan-core%40lists.berlios.de?Subject=Re%3A%20%5BPATCH%20net-next-2.6%20v5%201/1%5D%20can%3A%20c_can%3A%20Added%20support%20for%20Bosch%0A%09C_CAN%20controller&In-Reply-To=%3CD5ECB3C7A6F99444980976A8C6D896384DEE365EE8%40EAPEX1MAIL1.st.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005489.html">
   <LINK REL="Next"  HREF="005491.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[PATCH net-next-2.6 v5 1/1] can: c_can: Added support for Bosch	C_CAN controller</H1>
    <B>Bhupesh SHARMA</B> 
    <A HREF="mailto:socketcan-core%40lists.berlios.de?Subject=Re%3A%20%5BPATCH%20net-next-2.6%20v5%201/1%5D%20can%3A%20c_can%3A%20Added%20support%20for%20Bosch%0A%09C_CAN%20controller&In-Reply-To=%3CD5ECB3C7A6F99444980976A8C6D896384DEE365EE8%40EAPEX1MAIL1.st.com%3E"
       TITLE="[PATCH net-next-2.6 v5 1/1] can: c_can: Added support for Bosch	C_CAN controller">bhupesh.sharma at st.com
       </A><BR>
    <I>Tue Feb  8 11:45:39 CET 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="005489.html">[PATCH net-next-2.6 v5 1/1] can: c_can: Added support for Bosch	C_CAN controller
</A></li>
        <LI>Next message: <A HREF="005491.html">[PATCH net-next-2.6 v5 1/1] can: c_can: Added support for Bosch	C_CAN controller
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5490">[ date ]</a>
              <a href="thread.html#5490">[ thread ]</a>
              <a href="subject.html#5490">[ subject ]</a>
              <a href="author.html#5490">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> -----Original Message-----
</I>&gt;<i> From: Wolfgang Grandegger [mailto:<A HREF="https://lists.berlios.de/mailman/listinfo/socketcan-core">wg at grandegger.com</A>]
</I>&gt;<i> Sent: Tuesday, February 08, 2011 4:01 PM
</I>&gt;<i> To: Bhupesh SHARMA
</I>&gt;<i> Cc: <A HREF="https://lists.berlios.de/mailman/listinfo/socketcan-core">socketcan-core at lists.berlios.de</A>; <A HREF="https://lists.berlios.de/mailman/listinfo/socketcan-core">netdev at vger.kernel.org</A>; Marc
</I>&gt;<i> Kleine-Budde
</I>&gt;<i> Subject: Re: [PATCH net-next-2.6 v5 1/1] can: c_can: Added support for
</I>&gt;<i> Bosch C_CAN controller
</I>&gt;<i> 
</I>&gt;<i> On 02/08/2011 10:04 AM, Bhupesh SHARMA wrote:
</I>&gt;<i> &gt; Hi Wolfgang,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt;&gt; + stats-&gt;rx_errors++;
</I>&gt;<i> &gt;&gt;&gt; + cf-&gt;can_id |= CAN_ERR_PROT | CAN_ERR_BUSERROR;
</I>&gt;<i> &gt;&gt;&gt; + cf-&gt;data[2] |= CAN_ERR_PROT_UNSPEC;
</I>&gt;<i> &gt;&gt;&gt; +
</I>&gt;<i> &gt;&gt;&gt; + switch (lec_type) {
</I>&gt;<i> &gt;&gt;&gt; + case LEC_STUFF_ERROR:
</I>&gt;<i> &gt;&gt;&gt; + netdev_dbg(dev, &quot;stuff error\n&quot;);
</I>&gt;<i> &gt;&gt;&gt; + cf-&gt;data[2] |= CAN_ERR_PROT_STUFF;
</I>&gt;<i> &gt;&gt;&gt; + break;
</I>&gt;<i> &gt;&gt;&gt; +
</I>&gt;<i> &gt;&gt;&gt; + case LEC_FORM_ERROR:
</I>&gt;<i> &gt;&gt;&gt; + netdev_dbg(dev, &quot;form error\n&quot;);
</I>&gt;<i> &gt;&gt;&gt; + cf-&gt;data[2] |= CAN_ERR_PROT_FORM;
</I>&gt;<i> &gt;&gt;&gt; + break;
</I>&gt;<i> &gt;&gt;&gt; +
</I>&gt;<i> &gt;&gt;&gt; + case LEC_ACK_ERROR:
</I>&gt;<i> &gt;&gt;&gt; + netdev_dbg(dev, &quot;ack error\n&quot;);
</I>&gt;<i> &gt;&gt;&gt; + cf-&gt;data[2] |= (CAN_ERR_PROT_LOC_ACK |
</I>&gt;<i> &gt;&gt;&gt; + CAN_ERR_PROT_LOC_ACK_DEL);
</I>&gt;<i> &gt;&gt;&gt; + break;
</I>&gt;<i> &gt;&gt;&gt; +
</I>&gt;<i> &gt;&gt;&gt; + case LEC_BIT1_ERROR:
</I>&gt;<i> &gt;&gt;&gt; + netdev_dbg(dev, &quot;bit1 error\n&quot;);
</I>&gt;<i> &gt;&gt;&gt; + cf-&gt;data[2] |= CAN_ERR_PROT_BIT1;
</I>&gt;<i> &gt;&gt;&gt; + break;
</I>&gt;<i> &gt;&gt;&gt; +
</I>&gt;<i> &gt;&gt;&gt; + case LEC_BIT0_ERROR:
</I>&gt;<i> &gt;&gt;&gt; + netdev_dbg(dev, &quot;bit0 error\n&quot;);
</I>&gt;<i> &gt;&gt;&gt; + cf-&gt;data[2] |= CAN_ERR_PROT_BIT0;
</I>&gt;<i> &gt;&gt;&gt; + break;
</I>&gt;<i> &gt;&gt;&gt; +
</I>&gt;<i> &gt;&gt;&gt; + case LEC_CRC_ERROR:
</I>&gt;<i> &gt;&gt;&gt; + netdev_dbg(dev, &quot;CRC error\n&quot;);
</I>&gt;<i> &gt;&gt;&gt; + cf-&gt;data[2] |= (CAN_ERR_PROT_LOC_CRC_SEQ |
</I>&gt;<i> &gt;&gt;&gt; + CAN_ERR_PROT_LOC_CRC_DEL);
</I>&gt;<i> &gt;&gt;&gt; + break;
</I>&gt;<i> &gt;&gt;&gt; + }
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt;From the C_CAN manual:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; &quot;The LEC field holds a code which indicates the type of the last
</I>&gt;<i> error
</I>&gt;<i> &gt;&gt; to occur on the CAN bus. This field will be cleared to '0' when a
</I>&gt;<i> &gt;&gt; message has been transferred (reception or transmission) without
</I>&gt;<i> error.
</I>&gt;<i> &gt;&gt; The unused code '7' may be written by the CPU to check for updates.&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; Not sure if it's necessary to reset the lec at init and after an
</I>&gt;<i> error
</I>&gt;<i> &gt;&gt; to 0x7 and check it. More below...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I worked on your suggestion and instead found that the follow algo
</I>&gt;<i> must be used
</I>&gt;<i> &gt; for reading updated `lec` values:
</I>&gt;<i> &gt; a. Init lec by 0x07 at start.
</I>&gt;<i> &gt; b. In function `c_can_err` check if lec is 0x7 (no bus error since
</I>&gt;<i> this value was
</I>&gt;<i> &gt; written by CPU on status register) or 0x0 (no error). If so, return
</I>&gt;<i> without
</I>&gt;<i> &gt; sending an error frame on stack. Else, check for the lec error type
</I>&gt;<i> and
</I>&gt;<i> &gt; submit error frame on stack accordingly.
</I>&gt;<i> &gt; c. In case a lec error is found and served in `c_can_err` routine,
</I>&gt;<i> write
</I>&gt;<i> &gt; lec value to 0x07 again in status reg to check for updated lec later.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; This is my understanding after reading the specs time and again and
</I>&gt;<i> &gt; implementing/testing the logic.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Do you think this is fine or do you have any better approach?
</I>&gt;<i> 
</I>&gt;<i> That's what I remember from the CC770 driver. Search for lec in:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://svn.berlios.de/wsvn/socketcan/trunk/kernel/2.6/drivers/net/can/c">http://svn.berlios.de/wsvn/socketcan/trunk/kernel/2.6/drivers/net/can/c</A>
</I>&gt;<i> c770/cc770.c
</I>&gt;<i> 
</I>
Seems similar. But step (c) mentioned above seems missing from cc770.c driver,
i.e. &quot;In case a lec error is found and served (by means of sending an error
frame on the bus) write lec value to 0x07 again in status reg to check for updated
lec later-on. In my view seems logical to add it also. 


Regards,
Bhupesh

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005489.html">[PATCH net-next-2.6 v5 1/1] can: c_can: Added support for Bosch	C_CAN controller
</A></li>
	<LI>Next message: <A HREF="005491.html">[PATCH net-next-2.6 v5 1/1] can: c_can: Added support for Bosch	C_CAN controller
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5490">[ date ]</a>
              <a href="thread.html#5490">[ thread ]</a>
              <a href="subject.html#5490">[ subject ]</a>
              <a href="author.html#5490">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/socketcan-core">More information about the Socketcan-core
mailing list</a><br>
</body></html>
