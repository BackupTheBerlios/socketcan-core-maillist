<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> Self-reception and more
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/socketcan-core/2010-September/index.html" >
   <LINK REL="made" HREF="mailto:socketcan-core%40lists.berlios.de?Subject=Re%3A%20Self-reception%20and%20more&In-Reply-To=%3C166589D0B9DD2547A1319599B9BADA1F53ABEC%40vsv-exchange.ixxat.intranet.priv%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004676.html">
   <LINK REL="Next"  HREF="004656.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>Self-reception and more</H1>
    <B>gribov at ixxat.de</B> 
    <A HREF="mailto:socketcan-core%40lists.berlios.de?Subject=Re%3A%20Self-reception%20and%20more&In-Reply-To=%3C166589D0B9DD2547A1319599B9BADA1F53ABEC%40vsv-exchange.ixxat.intranet.priv%3E"
       TITLE="Self-reception and more">gribov at ixxat.de
       </A><BR>
    <I>Tue Sep 21 18:49:50 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="004676.html">Self-reception and more
</A></li>
        <LI>Next message: <A HREF="004656.html">Self-reception and more
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4654">[ date ]</a>
              <a href="thread.html#4654">[ thread ]</a>
              <a href="subject.html#4654">[ subject ]</a>
              <a href="author.html#4654">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Oliver,
Hello Wolfgang,

 
&gt;&gt;<i> If the self reception message is looped back to Rx queue in Tx 
</I>&gt;&gt;<i> interrupt (3) end becomes time stamp exactly at this moment - when we
</I>
&gt;&gt;<i> are getting the correct starting point for our timeout countdown. And
</I>
&gt;&gt;<i> important issue - if we are using active CAN interface (the one with 
</I>&gt;&gt;<i> own microcontroller), the timestamp shall be generated by 
</I>&gt;&gt;<i> microcontroller and passed to SocketCAN driver.
</I>&gt;<i>
</I>&gt;<i> The timestamp is set in netif_rx(). In the case above it's done at tx
</I>&gt;<i> completion interrupt, which looks like the behaviour you prefer to
</I>have.
&gt;<i>
</I>&gt;<i> Especially i would take a look into the per-socket filters, that would
</I>allow
&gt;<i> you to filter for exact CAN-Identifiers, which prevents your socket
</I>rx-queue
&gt;<i> to contain other stuff, that's sorted out in userspace. The used
</I>rx-queue
&gt;<i> could be really short then.
</I>&gt;<i>
</I>&gt;<i> E.g. you could use different sockets for different CAN-ID filters (and
</I>the
&gt;<i> select()-syscall) to handle all of them in your userspace app.
</I>
I was checking the sja100_start_xmit from sja1000.c and was captured by
the 
line:

.
	can_put_echo_skb(skb, dev, 0);
.

I thought this is the moment, when the tx message is looped back. But
obviously
this is happening in sja1000_interrupt on Tx interrupt event by the mean
of:

.
	can_get_echo_skb(dev, 0);
	netif_wake_queue(dev);
.

If this is like that, than I am surely OK with it.

I like the idea for using several opened socket on one interface for
it's
elegance, but afraid this is not applicable due to very critical
requirement:
the order of messages for both Tx and Rx messages shall be kept. 

Example from CANopen for reception: 
Imagine two CAN messages on the bus coming very close.
The first is PDO with data and the second is NMT command &quot;switch to
preop&quot;.
Received by the CANopen application in that order, this sequence will
cause
data update (PDO) and NMT state transition in state &quot;preop&quot; (we assume
state
&quot;operational&quot; before). In the &quot;preop&quot; state PDO processing is disabled.
So if
due to reception of PDO and NMT over different sockets the order of
message
processing will be changed (NMT before PDO), the application will switch
to
&quot;preop&quot; before processing the PDO and the data from that PDO will be
lost.



&gt;<i> I do not have a general problem with providing a flag - but *not*
</I>inside
&gt;<i> can_dlc ... which would break the userspace API as everyone would need
</I>to mask
&gt;<i> the bits then.
</I>&gt;<i>
</I>&gt;<i> Maybe we could use an existing/new information provided within a
</I>control
&gt;<i> message - see answer for &quot;C)&quot;
</I>

This was only an idea to use can_dlc. I am OK with any solution, like
using
padding bytes, what Wolfgang has proposed.


&gt;<i> The correct implementation with Wolfgangs echo_skb approach sends the
</I>sent CAN
&gt;<i> frame at tx completion interrupt. See sja1000.c sja1000_interrupt().
</I>&gt;<i> The timestamp is generated at tx completion interrupt.
</I>
OK.


&gt;<i> You can use recvmsg() - an example can be found for the timestamp and
</I>the
&gt;<i> dropcounter in trunk/can-utils/candump.c
</I>
Thanks!



Regards,
Vladislav


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004676.html">Self-reception and more
</A></li>
	<LI>Next message: <A HREF="004656.html">Self-reception and more
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4654">[ date ]</a>
              <a href="thread.html#4654">[ thread ]</a>
              <a href="subject.html#4654">[ subject ]</a>
              <a href="author.html#4654">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/socketcan-core">More information about the Socketcan-core
mailing list</a><br>
</body></html>
