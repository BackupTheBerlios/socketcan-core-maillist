<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [1/3] softing CANcard
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/socketcan-core/2008-June/index.html" >
   <LINK REL="made" HREF="mailto:socketcan-core%40lists.berlios.de?Subject=Re%3A%20%5B1/3%5D%20softing%20CANcard&In-Reply-To=%3C20080623150822.GA15893%40uranus.ravnborg.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001581.html">
   <LINK REL="Next"  HREF="001589.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[1/3] softing CANcard</H1>
    <B>Sam Ravnborg</B> 
    <A HREF="mailto:socketcan-core%40lists.berlios.de?Subject=Re%3A%20%5B1/3%5D%20softing%20CANcard&In-Reply-To=%3C20080623150822.GA15893%40uranus.ravnborg.org%3E"
       TITLE="[1/3] softing CANcard">sam at ravnborg.org
       </A><BR>
    <I>Mon Jun 23 17:08:22 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001581.html">[1/3] softing CANcard
</A></li>
        <LI>Next message: <A HREF="001589.html">[1/3] softing CANcard
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1588">[ date ]</a>
              <a href="thread.html#1588">[ thread ]</a>
              <a href="subject.html#1588">[ subject ]</a>
              <a href="author.html#1588">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, Jun 23, 2008 at 03:40:48PM +0200, Kurt Van Dijck wrote:
&gt;<i> Index: kernel/2.6/drivers/net/can/softing/Makefile
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- kernel/2.6/drivers/net/can/softing/Makefile	(revision 0)
</I>&gt;<i> +++ kernel/2.6/drivers/net/can/softing/Makefile	(revision 0)
</I>&gt;<i> @@ -0,0 +1,61 @@
</I>&gt;<i> +#
</I>&gt;<i> +#  $Id: Makefile 443 2007-07-25 11:41:27Z kurt_vd $
</I>&gt;<i> +#
</I>&gt;<i> +#  Copyright (c) 2008 EIA Electronics NV
</I>&gt;<i> +#  All rights reserved.
</I>&gt;<i> +#
</I>&gt;<i> +#  Redistribution and use in source and binary forms, with or without
</I>&gt;<i> +#  modification, are permitted provided that the following conditions
</I>&gt;<i> +#  are met:
</I>&gt;<i> +#  1. Redistributions of source code must retain the above copyright
</I>&gt;<i> +#     notice, this list of conditions, the following disclaimer and
</I>&gt;<i> +#     the referenced file 'COPYING'.
</I>&gt;<i> +#  2. Redistributions in binary form must reproduce the above copyright
</I>&gt;<i> +#     notice, this list of conditions and the following disclaimer in the
</I>&gt;<i> +#     documentation and/or other materials provided with the distribution.
</I>&gt;<i> +#  3. Neither the name of Volkswagen nor the names of its contributors
</I>&gt;<i> +#     may be used to endorse or promote products derived from this software
</I>&gt;<i> +#     without specific prior written permission.
</I>&gt;<i> +#
</I>&gt;<i> +#  Alternatively, provided that this notice is retained in full, this
</I>&gt;<i> +#  software may be distributed under the terms of the GNU General
</I>&gt;<i> +#  Public License (&quot;GPL&quot;) version 2 as distributed in the 'COPYING'
</I>&gt;<i> +#  file from the main directory of the linux kernel source.
</I>&gt;<i> +#
</I>&gt;<i> +#  The provided data structures and external interfaces from this code
</I>&gt;<i> +#  are not restricted to be used by modules with a GPL compatible license.
</I>&gt;<i> +#
</I>&gt;<i> +#  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
</I>&gt;<i> +#  &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
</I>&gt;<i> +#  LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
</I>&gt;<i> +#  A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
</I>&gt;<i> +#  OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
</I>&gt;<i> +#  SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
</I>&gt;<i> +#  LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
</I>&gt;<i> +#  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
</I>&gt;<i> +#  THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
</I>&gt;<i> +#  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
</I>&gt;<i> +#  OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
</I>&gt;<i> +#  DAMAGE.
</I>&gt;<i> +#
</I>&gt;<i> +#  Send feedback to &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/socketcan-core">socketcan-users at lists.berlios.de</A>&gt;
</I>&gt;<i> +
</I>&gt;<i> +
</I>&gt;<i> +ifeq ($(KERNELRELEASE),)
</I>&gt;<i> +
</I>&gt;<i> +KERNELDIR := /lib/modules/$(shell uname -r)/build
</I>&gt;<i> +PWD       := $(shell pwd)
</I>&gt;<i> +TOPDIR    := $(PWD)/../../../..
</I>&gt;<i> +
</I>&gt;<i> +modules modules_install clean:
</I>&gt;<i> +	$(MAKE) -C $(KERNELDIR) M=$(PWD) $@ TOPDIR=$(TOPDIR)
</I>&gt;<i> +
</I>&gt;<i> +else
</I>&gt;<i> +
</I>&gt;<i> +-include $(TOPDIR)/Makefile.common
</I>&gt;<i> +#EXTRA_CFLAGS += -I$(TOPDIR)/drivers/net/can/hal
</I>&gt;<i> +
</I>&gt;<i> +obj-$(CONFIG_CAN_SOFTING) 		+= softing.o
</I>&gt;<i> +obj-$(CONFIG_CAN_SOFTING_CS) 	+= softing_cs.o
</I>&gt;<i> +
</I>&gt;<i> +endif
</I>I'm not entirely familiar with the socet-can backwards compatibility stuff but..
1) Remove license text - we do not have it in Makefiles
2) Remove all the stuff not needed in kernel - so it boils down to:

+#Makefile for softing CAN driver
+obj-$(CONFIG_CAN_SOFTING)            += softing.o
+obj-$(CONFIG_CAN_SOFTING_CS)         += softing_cs.o


&gt;<i> Index: kernel/2.6/drivers/net/can/softing/softing.h
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- kernel/2.6/drivers/net/can/softing/softing.h	(revision 0)
</I>&gt;<i> +++ kernel/2.6/drivers/net/can/softing/softing.h	(revision 0)
</I>&gt;<i> @@ -0,0 +1,248 @@
</I>&gt;<i> +/*
</I>&gt;<i> + * softing.h -  Softing Gmbh 'generic' driver structures
</I>&gt;<i> + *
</I>&gt;<i> + * Copyright (c) 2008, Kurt Van Dijck, EIA Electronics, &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/socketcan-core">kurt.van.dijck at eia.be</A>&gt;
</I>&gt;<i> + *
</I>&gt;<i> + * Based on original, non-'socketcan', driver from Softing Gmbh
</I>&gt;<i> + *
</I>&gt;<i> + * Redistribution and use in source and binary forms, with or without
</I>&gt;<i> + * modification, are permitted provided that the following conditions
</I>&gt;<i> + * are met:
</I>&gt;<i> + * 1. Redistributions of source code must retain the above copyright
</I>&gt;<i> + *	   notice, this list of conditions and the following disclaimer.
</I>&gt;<i> + * 2. Redistributions in binary form must reproduce the above copyright
</I>&gt;<i> + *	   notice, this list of conditions and the following disclaimer in the
</I>&gt;<i> + *	   documentation and/or other materials provided with the distribution.
</I>&gt;<i> + * 3. Neither the name of EIA ELectronics nor the names of its contributors
</I>&gt;<i> + *	   may be used to endorse or promote products derived from this software
</I>&gt;<i> + *	   without specific prior written permission.
</I>&gt;<i> + *
</I>&gt;<i> + * Alternatively, provided that this notice is retained in full, this
</I>&gt;<i> + * software may be distributed under the terms of the GNU General
</I>&gt;<i> + * Public License (&quot;GPL&quot;) version 2, in which case the provisions of the
</I>&gt;<i> + * GPL apply INSTEAD OF those given above.
</I>&gt;<i> + *
</I>&gt;<i> + * The provided data structures and external interfaces from this code
</I>&gt;<i> + * are not restricted to be used by modules with a GPL compatible license.
</I>&gt;<i> + *
</I>&gt;<i> + * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
</I>&gt;<i> + * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
</I>&gt;<i> + * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
</I>&gt;<i> + * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
</I>&gt;<i> + * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
</I>&gt;<i> + * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
</I>&gt;<i> + * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
</I>&gt;<i> + * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
</I>&gt;<i> + * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
</I>&gt;<i> + * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
</I>&gt;<i> + * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
</I>&gt;<i> + * DAMAGE.
</I>&gt;<i> + *
</I>&gt;<i> + * Send feedback to &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/socketcan-core">socketcan-users at lists.berlios.de</A>&gt;
</I>&gt;<i> + *
</I>&gt;<i> + */
</I>We have the License text in the kernel.

&gt;<i> +
</I>&gt;<i> +#include &lt;linux/can.h&gt;
</I>&gt;<i> +#include &lt;linux/netdevice.h&gt;
</I>&gt;<i> +#include &lt;linux/can/dev.h&gt;
</I>&gt;<i> +#include &lt;linux/interrupt.h&gt;
</I>
Least specicif includes first. So can stuff in the end of the list.

&gt;<i> +
</I>&gt;<i> +struct softing;
</I>&gt;<i> +struct sofing_desc;
</I>&gt;<i> +
</I>&gt;<i> +/* special attribute, so we should not rely on the -&gt;priv pointers
</I>&gt;<i> + * before knowing how to interpret these
</I>&gt;<i> + */
</I>&gt;<i> +struct softing_attribute;
</I>&gt;<i> +
</I>&gt;<i> +struct softing_priv {
</I>&gt;<i> +	struct can_priv can;	/* must be the first member! */
</I>&gt;<i> +	struct net_device *netdev;
</I>&gt;<i> +	struct softing *card;
</I>&gt;<i> +	int index;
</I>&gt;<i> +	u8 sample;
</I>&gt;<i> +	u8 output;
</I>&gt;<i> +	u16 chip;
</I>&gt;<i> +	struct attribute_group sysfs;
</I>&gt;<i> +};
</I>&gt;<i> +#define netdev2softing(netdev)	((struct softing_priv *)netdev_priv(netdev))
</I>
static inline so we get type check?

&gt;<i> +
</I>&gt;<i> +struct softing {
</I>&gt;<i> +	int nbus;
</I>&gt;<i> +	struct softing_priv *bus[2];
</I>&gt;<i> +	spinlock_t	 spin; /* protect this structure &amp; DPRAM access */
</I>&gt;<i> +
</I>&gt;<i> +	struct {
</I>&gt;<i> +		/* indication of firmware status */
</I>&gt;<i> +		int up;
</I>&gt;<i> +		/* protection of the 'up' variable */
</I>&gt;<i> +		struct mutex lock;
</I>&gt;<i> +	} fw;
</I>&gt;<i> +	struct {
</I>&gt;<i> +		int nr;
</I>&gt;<i> +		int shared;
</I>&gt;<i> +		int requested;
</I>&gt;<i> +		struct tasklet_struct bh;
</I>&gt;<i> +		int svc_count;
</I>&gt;<i> +	} irq;
</I>&gt;<i> +	struct {
</I>&gt;<i> +		int pending;
</I>&gt;<i> +		int max;
</I>&gt;<i> +		int last_bus;
</I>&gt;<i> +		/* keep the bus that last tx'd a message,
</I>&gt;<i> +		 * in order to let every netdev queue resume
</I>&gt;<i> +		 */
</I>&gt;<i> +	} tx;
</I>&gt;<i> +	struct {
</I>&gt;<i> +		unsigned long phys;
</I>&gt;<i> +		unsigned long size;
</I>&gt;<i> +		unsigned char *virt;
</I>&gt;<i> +		unsigned char *end;
</I>&gt;<i> +		struct softing_fct  *fct;
</I>&gt;<i> +		struct softing_info *info;
</I>&gt;<i> +		struct softing_rx  *rx;
</I>&gt;<i> +		struct softing_tx  *tx;
</I>&gt;<i> +		struct softing_irq *irq;
</I>&gt;<i> +		unsigned short *command;
</I>&gt;<i> +		unsigned short *receipt;
</I>&gt;<i> +	} dpram;
</I>&gt;<i> +	struct {
</I>&gt;<i> +		unsigned short manf;
</I>&gt;<i> +		unsigned short prod;
</I>&gt;<i> +		u32  serial, fw, hw, lic;
</I>&gt;<i> +		u16  chip [2];
</I>&gt;<i> +		u32  freq;
</I>&gt;<i> +		const char *name;
</I>&gt;<i> +	} id;
</I>&gt;<i> +	const struct softing_desc		*desc;
</I>&gt;<i> +	struct {
</I>&gt;<i> +		int (*reset)     (struct softing *, int);
</I>&gt;<i> +		int (*enable_irq)(struct softing *, int);
</I>&gt;<i> +	} fn;
</I>&gt;<i> +	struct device *dev;
</I>&gt;<i> +	/* sysfs */
</I>&gt;<i> +	struct attribute_group sysfs;
</I>&gt;<i> +	struct softing_attribute *attr;
</I>&gt;<i> +	struct attribute **grp;
</I>&gt;<i> +};
</I>&gt;<i> +
</I>&gt;<i> +extern int	mk_softing(struct softing *);
</I>&gt;<i> +/* fields that must be set already are :
</I>&gt;<i> + * ncan
</I>&gt;<i> + * id.manf
</I>&gt;<i> + * id.prod
</I>&gt;<i> + * fn.reset
</I>&gt;<i> + * fn.enable_irq
</I>&gt;<i> + */
</I>&gt;<i> +extern void rm_softing(struct softing *);
</I>&gt;<i> +#if 0 /* set 1 for resume/suspend functions */
</I>&gt;<i> +extern int	softing_resume(struct softing *);
</I>&gt;<i> +extern void softing_suspend(struct softing *);
</I>&gt;<i> +#else
</I>&gt;<i> +#define softing_resume	0
</I>&gt;<i> +#define softing_suspend 0
</I>&gt;<i> +#endif
</I>
CONFIG_PM_SUSPEND?

&gt;<i> +/* SOFTING DPRAM mappings */
</I>&gt;<i> +struct softing_rx {
</I>&gt;<i> +	u8  fifo[16][32];
</I>&gt;<i> +	u8  dummy1;
</I>&gt;<i> +	u16 rd;
</I>&gt;<i> +	u16 dummy2;
</I>&gt;<i> +	u16 wr;
</I>&gt;<i> +	u16  dummy3;
</I>&gt;<i> +	u16 lost_msg;
</I>&gt;<i> +} __attribute__((packed));
</I>&gt;<i> +
</I>&gt;<i> +struct softing_tx {
</I>&gt;<i> +	u8  fifo[32][16];
</I>&gt;<i> +	u8  dummy1;
</I>&gt;<i> +	u16 rd;
</I>&gt;<i> +	u16 dummy2;
</I>&gt;<i> +	u16 wr;
</I>&gt;<i> +	u8  dummy3;
</I>&gt;<i> +} __attribute__((packed));
</I>&gt;<i> +
</I>&gt;<i> +struct softing_irq {
</I>&gt;<i> +	u8 to_host;
</I>&gt;<i> +	u8 to_card;
</I>&gt;<i> +} __attribute__((packed));
</I>&gt;<i> +
</I>&gt;<i> +struct softing_fct {
</I>&gt;<i> +	s16 param[20]; /* 0 is index */
</I>&gt;<i> +	s16 returned;
</I>&gt;<i> +	u8  dummy;
</I>&gt;<i> +	u16 host_access;
</I>&gt;<i> +} __attribute__((packed));
</I>&gt;<i> +
</I>&gt;<i> +struct softing_info {
</I>&gt;<i> +	u8  dummy1;
</I>&gt;<i> +	u16 bus_state;
</I>&gt;<i> +	u16 dummy2;
</I>&gt;<i> +	u16 bus_state2;
</I>&gt;<i> +	u16 dummy3;
</I>&gt;<i> +	u16 error_state;
</I>&gt;<i> +	u16 dummy4;
</I>&gt;<i> +	u16 error_state2;
</I>&gt;<i> +	u16 dummy5;
</I>&gt;<i> +	u16 reset;
</I>&gt;<i> +	u16 dummy6;
</I>&gt;<i> +	u16 clear_rcv_fifo;
</I>&gt;<i> +	u16 dummy7;
</I>&gt;<i> +	u16 dummyxx;
</I>&gt;<i> +	u16 dummy8;
</I>&gt;<i> +	u16 time_reset;
</I>&gt;<i> +	u8  dummy9;
</I>&gt;<i> +	u32 time;
</I>&gt;<i> +	u32 time_wrap;
</I>&gt;<i> +	u8  wr_start;
</I>&gt;<i> +	u8  wr_end;
</I>&gt;<i> +	u8  dummy10;
</I>&gt;<i> +	u16 dummy12;
</I>&gt;<i> +	u16 dummy12x;
</I>&gt;<i> +	u16 dummy13;
</I>&gt;<i> +	u16 reset_rcv_fifo;
</I>&gt;<i> +	u8  dummy14;
</I>&gt;<i> +	u8  reset_xmt_fifo;
</I>&gt;<i> +	u8  read_fifo_levels;
</I>&gt;<i> +	u16 rcv_fifo_level;
</I>&gt;<i> +	u16 xmt_fifo_level;
</I>&gt;<i> +} __attribute__((packed));
</I>&gt;<i> +
</I>&gt;<i> +/* DPRAM return codes */
</I>&gt;<i> +#define RES_NONE 0
</I>&gt;<i> +#define RES_OK   1
</I>&gt;<i> +#define RES_NOK  2
</I>&gt;<i> +#define RES_UNKNOWN 3
</I>&gt;<i> +/* DPRAM flags */
</I>&gt;<i> +#define CMD_TX		0x01
</I>&gt;<i> +#define CMD_ACK	0x02
</I>&gt;<i> +#define CMD_XTD	0x04
</I>&gt;<i> +#define CMD_RTR	0x08
</I>&gt;<i> +#define CMD_ERR	0x10
</I>&gt;<i> +#define CMD_BUS2	0x80
</I>&gt;<i> +
</I>&gt;<i> +/* debug */
</I>&gt;<i> +extern int softing_debug;
</I>&gt;<i> +
</I>&gt;<i> +#define mod_alert(fmt,arg...) { \
</I>&gt;<i> +	if (softing_debug &gt;= 0) \
</I>&gt;<i> +		printk(KERN_ALERT &quot;[%s] %s:&quot; fmt &quot;\n&quot; \
</I>&gt;<i> +				, THIS_MODULE-&gt;name \
</I>&gt;<i> +				, __FUNCTION__ \
</I>&gt;<i> +				, ##arg); \
</I>&gt;<i> +	}
</I>&gt;<i> +#define mod_info(fmt,arg...) { \
</I>&gt;<i> +	if (softing_debug &gt;= 1) \
</I>&gt;<i> +		printk(KERN_INFO  &quot;[%s] %s:&quot; fmt &quot;\n&quot;\
</I>&gt;<i> +				, THIS_MODULE-&gt;name \
</I>&gt;<i> +				, __FUNCTION__ \
</I>&gt;<i> +				, ##arg); \
</I>&gt;<i> +	}
</I>&gt;<i> +#define mod_trace(fmt,arg...) { \
</I>&gt;<i> +	if (softing_debug &gt;= 2) \
</I>&gt;<i> +		printk(KERN_DEBUG &quot;[%s] %s:&quot; fmt &quot;\n&quot; \
</I>&gt;<i> +				, THIS_MODULE-&gt;name \
</I>&gt;<i> +				, __FUNCTION__ \
</I>&gt;<i> +				, ##arg); \
</I>&gt;<i> +	}
</I>&gt;<i> +
</I>Candidates for devinfo and friends?

	Sam

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001581.html">[1/3] softing CANcard
</A></li>
	<LI>Next message: <A HREF="001589.html">[1/3] softing CANcard
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1588">[ date ]</a>
              <a href="thread.html#1588">[ thread ]</a>
              <a href="subject.html#1588">[ subject ]</a>
              <a href="author.html#1588">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/socketcan-core">More information about the Socketcan-core
mailing list</a><br>
</body></html>
