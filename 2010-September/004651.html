<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> Self-reception and more
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/socketcan-core/2010-September/index.html" >
   <LINK REL="made" HREF="mailto:socketcan-core%40lists.berlios.de?Subject=Re%3A%20Self-reception%20and%20more&In-Reply-To=%3C4C97C8BB.8080603%40hartkopp.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004650.html">
   <LINK REL="Next"  HREF="004653.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>Self-reception and more</H1>
    <B>Oliver Hartkopp</B> 
    <A HREF="mailto:socketcan-core%40lists.berlios.de?Subject=Re%3A%20Self-reception%20and%20more&In-Reply-To=%3C4C97C8BB.8080603%40hartkopp.net%3E"
       TITLE="Self-reception and more">socketcan at hartkopp.net
       </A><BR>
    <I>Mon Sep 20 22:48:59 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="004650.html">Self-reception and more
</A></li>
        <LI>Next message: <A HREF="004653.html">Self-reception and more
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4651">[ date ]</a>
              <a href="thread.html#4651">[ thread ]</a>
              <a href="subject.html#4651">[ subject ]</a>
              <a href="author.html#4651">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20.09.2010 16:28, <A HREF="https://lists.berlios.de/mailman/listinfo/socketcan-core">gribov at ixxat.de</A> wrote:
&gt;<i> Hello all,
</I>&gt;<i> 
</I>
Hello Vladislav,

&gt;<i> 
</I>&gt;<i> So, for getting the really correct Tx time stamp, the self reception 
</I>&gt;<i> message shall be written back to Rx queue and &quot;labeled&quot; with 
</I>&gt;<i> timestamp at the moment it really sent on the CAN, means in Tx 
</I>&gt;<i> interrupt:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>          socket
</I>&gt;<i>          write
</I>&gt;<i>            |
</I>&gt;<i>           (1)
</I>&gt;<i>            |
</I>&gt;<i> TxQueue  --********--------------------
</I>&gt;<i>                   |
</I>&gt;<i>                  (2a)
</I>&gt;<i>                   |
</I>&gt;<i> CAN buff ---------********-------------
</I>&gt;<i>                       |  |
</I>&gt;<i>                       | (3)
</I>&gt;<i>                       |  |
</I>&gt;<i> CANbus  --------------***--------------
</I>&gt;<i>                          |
</I>&gt;<i> RxQueue -----------------*********-----
</I>&gt;<i>                                  |
</I>&gt;<i>                                 (2)
</I>&gt;<i>                                  |
</I>&gt;<i>                                socket
</I>&gt;<i>                                read
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> If the self reception message is looped back to Rx queue in Tx 
</I>&gt;<i> interrupt (3) end becomes time stamp exactly at this moment - when we 
</I>&gt;<i> are getting the correct starting point for our timeout countdown. And 
</I>&gt;<i> important issue - if we are using active CAN interface (the one with 
</I>&gt;<i> own microcontroller), the timestamp shall be generated by 
</I>&gt;<i> microcontroller and passed to SocketCAN driver.
</I>
The timestamp is set in netif_rx(). In the case above it's done at tx
completion interrupt, which looks like the behaviour you prefer to have.

Especially i would take a look into the per-socket filters, that would allow
you to filter for exact CAN-Identifiers, which prevents your socket rx-queue
to contain other stuff, that's sorted out in userspace. The used rx-queue
could be really short then.

E.g. you could use different sockets for different CAN-ID filters (and the
select()-syscall) to handle all of them in your userspace app.

&gt;<i> 
</I>&gt;<i> &lt;--------------------------------------------------------------------&gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> So, to sum that much stuff up:
</I>&gt;<i> 
</I>&gt;<i> A) The proposal to extend CAN message with self reception flag. The
</I>&gt;<i>    self-received messages will have that flag set. One of the 4 unused
</I>&gt;<i>    bits of the can_frame.can_dlc may be e.g. used for that.
</I>
I do not have a general problem with providing a flag - but *not* inside
can_dlc ... which would break the userspace API as everyone would need to mask
the bits then.

Maybe we could use an existing/new information provided within a control
message - see answer for &quot;C)&quot;

&gt;<i> B) Is it possible to label CAN packets in the similar way as done by
</I>&gt;<i>    &quot;--set-mark&quot; in iptables?
</I>
??? Need to look into the ideas there. Maybe i can go for that tommorow.

&gt;<i> C) The looping back of self reception messages shall be done in CAN
</I>&gt;<i>    Tx interrupt and not in the &quot;.ndo_start_xmit&quot; .
</I>
The correct implementation with Wolfgangs echo_skb approach sends the sent CAN
frame at tx completion interrupt. See sja1000.c sja1000_interrupt().
The timestamp is generated at tx completion interrupt.

&gt;<i> D) Do we still need extra ioctl call to get the Rx message timestamp?
</I>&gt;<i>    I remember the discussion about the possibility to pass timestamp 
</I>&gt;<i>    with the message itself about two years ago.
</I>
You can use recvmsg() - an example can be found for the timestamp and the
dropcounter in trunk/can-utils/candump.c

602  nbytes = recvmsg(s[i], &amp;msg, 0);

(..)

627  for (cmsg = CMSG_FIRSTHDR(&amp;msg);
628 	cmsg &amp;&amp; (cmsg-&gt;cmsg_level == SOL_SOCKET);
629 	cmsg = CMSG_NXTHDR(&amp;msg,cmsg)) {
630  	if (cmsg-&gt;cmsg_type == SO_TIMESTAMP)
631   	  tv = *(struct timeval *)CMSG_DATA(cmsg);
632 	else if (cmsg-&gt;cmsg_type == SO_RXQ_OVFL)
633 	  dropcnt[i] = *(__u32 *)CMSG_DATA(cmsg);
634 	}


&gt;<i> 
</I>&gt;<i> Regards and RFC,
</I>&gt;<i> Vladislav
</I>
Thanks for your ideas!
Oliver

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004650.html">Self-reception and more
</A></li>
	<LI>Next message: <A HREF="004653.html">Self-reception and more
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4651">[ date ]</a>
              <a href="thread.html#4651">[ thread ]</a>
              <a href="subject.html#4651">[ subject ]</a>
              <a href="author.html#4651">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/socketcan-core">More information about the Socketcan-core
mailing list</a><br>
</body></html>
